<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>지도 페이지</title>

    <!-- 배너 fragment -->
    <link rel="stylesheet" th:href="@{/css/header.css}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/meyer-reset/2.0/reset.min.css">
    <script defer th:src="@{/js/header.js}"></script>

    <!-- jQuery -->
    <script th:src="@{/js/jquery-3.7.1.js}"></script>

    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
    <!-- csv 파일 읽기 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>

    <!-- Mapbox CSS -->
    <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet">
    <!-- Mapbox JS -->
    <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>


    <!-- Chart.js 본체 -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js"></script>
    <!-- DataLabels 플러그인 -->
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>

    <!-- 플러그인 등록 (Chart v3/v4) -->
    <script>
        if (window.Chart && window.ChartDataLabels) {
            Chart.register(ChartDataLabels);
        }
    </script>

    <!-- 지도 map.js -->
    <script defer th:src="@{/js/map.js}"></script>

    <!-- 지도 위 본문 내용 js -->
    <script defer th:src="@{/js/portpredict.js}"></script>

    <!-- portpredict CSS -->
    <link rel="stylesheet" th:href="@{/css/portpredict.css}">
</head>

<body>
    <div sec:authorize="isAnonymous()">
        <div th:insert="~{fragment/header :: bu3_navigation}"></div>
    </div>
    <div sec:authorize="isAuthenticated()">
        <div th:insert="~{fragment/headerJoin :: bu3_navigation_join}"></div>
    </div>

    <!-- 전체 래퍼(지도는 뒤, 사이드바는 위에 겹침) -->
    <div class="map-wrap">
        <!-- 지도 -->
        <div id="map" data-projection="mercator"></div>

        <!-- 우상단 아이콘 컨트롤 -->
        <div class="map-icon-ctrl" aria-label="지도 보조 컨트롤">
            <button id="map-style-btn" class="iconbtn" data-type="style" data-tip="지도 스타일">
                <img src="/images/portpredictImages/map.png" th:src="@{/images/portpredictImages/map.png}"
                    alt="지도 스타일" />
            </button>
            <button id="congestion-btn" class="iconbtn" data-type="congestion" data-tip="혼잡도" aria-pressed="false">
                <img src="/images/portpredictImages/ship_congestion.png"
                    th:src="@{/images/portpredictImages/ship_congestion.png}" alt="혼잡도" />
            </button>
            <button id="weather-btn" class="iconbtn" data-type="weather" data-tip="날씨">
                <img src="/images/portpredictImages/weather.png" th:src="@{/images/portpredictImages/weather.png}"
                    alt="날씨" />
            </button>
        </div>

        <div id="congestionGraphModal" class="modal" aria-hidden="true">
            <div class="modal__bg" data-action="close"></div>
            <div class="modal__dialog" role="dialog" aria-modal="true" aria-labelledby="congestionGraphTitle">
                <div class="modal__header">
                    <h3 id="congestionGraphTitle" class="modal__title">항구 혼잡도</h3>
                    <button class="modal__close" data-action="close" aria-label="모달 닫기">×</button>
                </div>
                <div class="modal__content">
                    <div id="congestionGraphChart"></div>
                </div>
            </div>
        </div>

        <!-- 왼쪽 슬라이드 사이드바 -->
        <div class="sidebar" aria-label="차항지 예측 패널">
            <!-- 핸들 -->
            <button class="sidebar__handle" type="button" aria-controls="sidebar-content" aria-expanded="true"
                title="패널 열기/닫기">
                <span class="chevron" aria-hidden="true"></span>
            </button>

            <!-- 항상 상단 고정되는 회색 박스 -->
            <div class="sidebar__topbox">
                <button class="iconwrap port" data-panel="predict" data-tip="차항지 예측" aria-label="차항지 예측" type="button">
                    <img src="/images/portpredictImages/port.png" th:src="@{/images/portpredictImages/port.png}"
                        alt="Port Icon" class="sidebar__icon">
                </button>

                <button class="iconwrap time" data-panel="log" data-tip="시점별 예측 타임라인" aria-label="시점별 예측 타임라인"
                    type="button">
                    <img src="/images/portpredictImages/log.png" th:src="@{/images/portpredictImages/log.png}"
                        alt="Log Icon" class="sidebar__icon">
                </button>
            </div>


            <!-- 1) 예측 슬라이드 바-->
            <div class="panel panel--predict is-active">
                <!-- 상단 고정: 제목 + 폼 + hr -->
                <div class="sidebar__header">
                    <h2 class="sidebar__title">차항지 예측</h2>

                    <!-- 선박 고유 번호 select box -->
                    <div class="sidebar__section">
                        <div class="cselect" data-name="idType"
                            th:attr="data-value=${prefillType != null ? prefillType : 'MMSI'}">

                            <button type="button" class="cselect__control" aria-haspopup="listbox"
                                aria-expanded="false">
                                <span class="cselect__value" data-value="MMSI"
                                    th:attr="data-value=${prefillType != null ? prefillType : 'MMSI'}"
                                    th:text="${prefillType != null ? prefillType : 'MMSI'}">MMSI</span>
                                <span class="cselect__caret" aria-hidden="true"></span>
                            </button>

                            <ul class="cselect__menu" role="listbox" tabindex="-1">
                                <li class="cselect__option" role="option" data-value="MMSI" aria-selected="true"
                                    th:attr="aria-selected=${prefillType == 'MMSI'}">
                                    MMSI
                                </li>
                                <li class="cselect__option" role="option" data-value="IMO"
                                    th:attr="aria-selected=${prefillType == 'IMO'}">
                                    IMO</li>
                            </ul>
                        </div>
                    </div>

                    <div class="sidebar__section">
                        <div class="sidebar__row">
                            <!-- 입력 + 버튼 -->
                            <input id="imo vslInput" type="text" class="sidebar__input" placeholder="선박 고유 번호 입력"
                                th:value="${prefillVsl}" />
                            <button class="sidebar__btn primary">조회</button>
                            <button class="sidebar__btn">초기화</button>
                        </div>
                    </div>

                    <!-- 상단 고정 구역의 구분선 -->
                    <hr class="sidebar__divider" />
                </div>

                <!-- 스피너/로딩 상태 표시 -->
                <div id="loading-spinner" style="display: none;">
                    <div class="spinner"></div>
                    <p>데이터를 불러오는 중입니다...</p>
                </div>
                <!-- 가운데만 스크롤 되는 영역 -->
                <div id="predict-content" class="sidebar__content is-hidden">
                    <!-- 선박 정보 -->
                    <div class="sidebar__vesselinfo">
                        <h3 class="sidebar__sub">선박 정보</h3>
                        <img src="/images/portpredictImages/vessel.jpg" th:src="@{/images/portpredictImages/vessel.jpg}"
                            alt="vessel image" class="vessel_image" />
                        <div class="kv"><span>CALL SIGN</span><strong>S6AS6</strong></div>
                        <div class="kv"><span>SHIP TYPE</span><strong>CONTAINER</strong></div>
                        <div class="kv"><span>VSL_LENGTH</span><strong>213 m</strong></div>
                        <div class="kv"><span>VSL_WIDTH</span><strong>32 m</strong></div>
                    </div>

                    <!-- 예측 결과 -->
                    <div class="sidebar__predict">
                        <h3 class="sidebar__sub">예측 결과</h3>
                        <!-- Top 1~3 박스 -->
                        <div class="box one">
                            <div class="box__head">
                                <span class="head__label">Top - <span class="head__label num">1</span>
                                </span>
                                <strong>71.8%</strong>
                            </div>
                            <div class="box__body">
                                <div class="route__bg">
                                    <div class="route">
                                        <div>
                                            <b>KRBUS</b>
                                            <div class="sub">한국 / 부산</div>
                                        </div>
                                        <div class="arrow">»</div>
                                        <div>
                                            <b class="last">CNSHA</b>
                                            <div class="sub dest">중국 / 상하이</div>
                                        </div>
                                    </div>
                                </div>
                                <div class="eta__time"><span class="pill">ETA</span> 2025-10-19 4:42:31</div>
                            </div>
                        </div>

                        <div class="box two">
                            <div class="box__head">
                                <span class="head__label">Top - 2</span>
                                <strong>17.8%</strong>
                            </div>
                            <div class="box__body">
                                <div class="route__bg">
                                    <div class="route">
                                        <div>
                                            <b>KRBUS</b>
                                            <div class="sub">한국 / 부산</div>
                                        </div>
                                        <div class="arrow">»</div>
                                        <div>
                                            <b class="last">HKHKG</b>
                                            <div class="sub dest">홍콩 / 홍콩</div>
                                        </div>
                                    </div>
                                </div>
                                <div class="eta__time"><span class="pill">ETA</span> 2025-10-19 4:42:31</div>
                            </div>
                        </div>

                        <div class="box three">
                            <div class="box__head">
                                <span class="head__label">Top - 3</span>
                                <strong>10.4%</strong>
                            </div>
                            <div class="box__body">
                                <div class="route__bg">
                                    <div class="route">
                                        <div>
                                            <b>KRBUS</b>
                                            <div class="sub">한국 / 부산</div>
                                        </div>
                                        <div class="arrow">»</div>
                                        <div>
                                            <b class="last">TWKHH</b>
                                            <div class="sub dest">대만 / 가오슝</div>
                                        </div>
                                    </div>
                                </div>
                                <div class="eta__time"><span class="pill">ETA</span> 2025-10-19 4:42:31</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 항상 하단 고정 -->
                <div class="sidebar__bottombox">
                    <button class="sidebar__btn save">결과 저장</button>
                </div>
            </div>
            <!--  로그 슬라이드 바!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!-->
            <!-- 2) 로그 슬라이드 바 -->
            <div class="panel panel--log">
                <div class="sidebar__header">
                    <h2 class="sidebar__secondtitle">시점별 예측 타임라인</h2>
                    <hr class="secondtitle_hr">
                </div>
                <div id="log-content" class="sidebar__content">
                    <ol class="voy-timeline"></ol>
                </div>
            </div>
            <!-- 로그 슬라이드 바 끝-->

        </div>
    </div>
    <!-- 저장 확인 모달 -->
    <div id="saveModal" class="modal" aria-hidden="true">
        <div class="modal__bg" data-action="close"></div>
        <div class="modal__dialog" role="dialog" aria-modal="true" aria-labelledby="saveModalTitle">
            <h3 id="saveModalTitle" class="modal__title">결과를 저장할까요?</h3>
            <div class="modal__actions">
                <button class="modal__btn primary" data-action="yes">예</button>
                <button class="modal__btn secondary" data-action="no">아니오</button>
            </div>
        </div>
    </div>

    <script src="/js/env-api.js"></script> <!-- Open-Meteo util -->
    <script src="/js/vessel-map.js"></script> <!-- 선박/팝업 -->
</body>

</html>